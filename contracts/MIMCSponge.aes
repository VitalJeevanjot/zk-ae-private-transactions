include "List.aes"

contract MIMCSponge =

    entrypoint multiple_hasher(inputs: list(int)): list(int) =
        hasher(inputs)
        hasher(inputs)
        // hasher(inputs)
        // hasher(inputs)
        // hasher(inputs)
        // hasher(inputs)
        // hasher(inputs)
        // hasher(inputs)
        // hasher(inputs)
        // hasher(inputs)
        // hasher(inputs)

    entrypoint hasher(inputs: list(int)) : list(int) =
        require(List.length(inputs) == 2, "only 2 inputs accepted!")
        let s : list(list(int)) = run_input_loop(inputs, 0, 0, [[]])
        let outs: list(int) = [List.get(0, List.get(1, s))] // inputs - 1 = 1
        outs
        // // Getting 2 outputs for my case
        // outs ++ [List.get(0, mimcFeistel(List.get(0, List.get(1, s)), List.get(1, List.get(1, s)), 0))]

    function run_input_loop(ins: list(int), 
        i: int, 
        j: int, 
        s: list(list(int))): list(list(int)) =
            switch(ins)
                [] => s
                (inp :: ins) =>
                    let _s: list(list(int)) = 
                        if(i == 0)
                            [mimcFeistel(inp, 0, 0)]
                        else
                            s ++ [mimcFeistel(List.get(0, List.get(j, s)) + inp, List.get(1, List.get(j, s)), 0)]
                    let i: int = i + 1
                    run_input_loop(ins, i, i - 1, _s)


    function mimcFeistel(xL_in: int, xR_in: int, k: int): list(int) =
      let iv : list(int) = [
        0,
        7120861356467848435263064379192047478074060781135320967663101236819528304084,
        70689433897239714865317093925917138723043752151259405256620021708555425923532,
        17980351014018068290387269214713820287804403312720763401943303895585469787384,
        19886576439381707240399940949310933992335779767309383709787331470398675714258,
        23101958150063061948052561406995951992068715260094353934029412146957343098216,
        40050381125239234053296951000671963327678952655307234814632436701258393230128,
        51443948025144720602351070688490938853517575848436989943757882543131654573110,
        94760522985834939341271833970242083205311547002792293507112624138763622419425,
        53640669055336497251748711694356327987906953415950698645212602100706238085072,
        4798196928559910300796064665904583125427459076060519468052008159779219347957,
        83051967110105970924224035297261914229318368722498256717308810133423346887801,
        75670063377448124723774272605860638496494903767482219802846537653361562061593,
        77562270630278561876410080959003674893875476321046589518994151577193686795613,
        104324752050880893900268896668283085920370690488564648746448891159665376135011,
        44525750597697375253956979980299663515022129488181425775809541087632199909740,
        69348374353021530709367815786210220605028665665453091046529571988404078062182,
        29444993723623098136919721956387182871227874128762395712677095770951359681872,
        42279532250924072636803845029947229187269583601587561726989729862910116798640,
        18146517657445423462330854383025300323335289319277199154920964274562014376193,
        29968416337106811454780852581405936340535417705810682248910986165675725110909,
        98349414494256551134487694113004832027105204731469481097021230104811039513609,
        114845501969561337178890689009531666676750514305200642023523097344935807204594,
        26512137355234398742490373463572605266574321495918581157627494519839928718785,
        38733996020041052414653364419459849840273602340396669205647157375896170703414,
        92175141973941805658506623992424921240223266122250645248210369913065604276139,
        16688277490485052681847773549197928630624828392248424077804829676011512392564,
        99431624348540768637823811974699012983767170873547262833631311055260923073427,
        89989417213104073176481761363793743562985171588340266635382484610770244111950,
        23776341561384426793309673551863785121247041729339774401778834828318133563494,
        22037166978343340887075461343574097072417773982039280124203805713362600176719,
        18875020877782404439294079398043479420415331640996249745272087358069018086569,
        102742664900677329734975949195165920661843023038901231082639499543952663498308,
        63445935867151208225775796719883898398003276135913798892424507583594249525313,
        114963136577460999522612576631496514954092528094651071794218576716119744299858,
        4144769320246558352780591737261172907511489963810975650573703217887429086546,
        10097732913112662248360143041019433907849917041759137293018029019134392559350,
        111161273787169099145339794072029711890689344475390241693633504915632223516406,
        50078873963558777695818419879049731628283859855043457043960043141404918281350,
        6745410632962119604799318394592010194450845483518862700079921360015766217097,
        54634642978944134068728662150976874646896281797702848926388455336159108297456,
        42130141766579368955293458561833969523921242119488382157763431984481939353210,
        53942266526439761965328841108261527480400064404670411979828168384728145318643,
        2832093654883670345969792724123161241696170611611744759675180839473215203706,
        87705983209712627715218705364389157941443276351383571291051062846371492937205,
        63973456384266001803031940820685186472339870459862277216735323279587626078177,
        46957459660689095772805951326497015047735250691217671713053838581293111460890,
        17198004293191777441573635123110935015228014028618868252989374962722329283022,
        95195131996585770027614138439970759543873967355315766851192333078527559739600,
        19346204940546791021518535594447257347218878114049998691060016493806845179755,
        55278296612285420835620677678909085507792935618434329298198305416050233808506,
        46890459191070604266317239160900802974908533755578122148794381341533188288739,
        6545064306297957002139416752334741502722251869537551068239642131448768236585,
        5203908808704813498389265425172875593837960384349653691918590736979872578408,
        46023178175689841026652873619585312184471231437839176005501814000061930801458,
        77425299050950014794384908485372646330528874878941190804553678134086718335988,
        93096720969848441421533030704493709682401448386517519172482282891227432374307,
        52614034937669109207269332312533244244034331377713566030981312276031894760536,
        12855514863299373699594410385788943772765811961581749194183533625311486462501,
        27251903546528396899121474879526661580930585336015815465004841986837721015346,
        78827071019097129617288946083902653359142794467488560510788603667944733436286,
        66581670254844695250153686438682131694611751008147892002043393767228677303581,
        37506832428423709656256273961443390505383859205590192832334204767335500669845,
        8959562060028569701043973060670353733575345393653685776974948916988033453971,
        60167240208011952156758387440388919334796022641348871114017625182056696118884,
        43944768140426338959401520582272141403192172703333434187400026557057113151669,
        8327443473179334761744301768309008451162322941906921742120510244986704677004,
        17213012626801210615058753489149961717422101711567228037597150941152495100640,
        97947341128890837604235865380227197650316440088180393783474742170379482934748,
        83449115450910148320935388351065526066470864411648255535871419178619595649099,
        82197918555354913560103217626412973782124241765438523389944200518888652269833,
        40613638986050645429324840061158001427095985560891567840561502277599320440693,
        7132325028834551397904855671244375895110341505383911719294705267624034122405,
        148317947440800089795933930720822493695520852448386394775371401743494965187,
        106554022159114821241876402108722893984444724481658840098429576635681621035524,
        84489003027287655941617056601500476374079498057051947599329475505341192098311,
        34659657202033226378630404135681338559314591068402458305387916743914585669822,
        98885018062157380618664226469774395552232371105059767165006194847469722227125,
        9607550223176946388146938069307456967842408600269548190739947540821716354749,
        96309356775819445439185852155465053457355765306974945203444121411623280765051,
        176061952957067086877570020242717222844908281373122372938833890096257042779,
        99753184464839749195744615386095022078603299542335303392413745694170059233325,
        32756696495947150739112552245134405790477428033375694606064837020080558524475,
        23904338266239082475843193497391848295750932275873594914793790930454761946355,
        87480306839286156100541330688111313541349239097792584123109524385383816054365,
        114364987206889940888976754366996572457923413952448665866520067376312145859706,
        111254799302878590901034259492021196591944294895459437038589837834149267068069,
        76474852431783438439661330639603790081369202929535675287696623269016406143349,
        110594883482593631813756749932797561000723839412237127934956141389135330905106,
        92560490146623531089120101909373623004069924970942860139890682408801007749620,
        46287918290617142236529451481121014492218375468861320972684732037502283542871,
        32883284540320451295484135704808083452381176816565850047310272290579727564,
        76149585529796938279350210654177368576191839853986644192886113710721514166408,
        23914976631484794694805202158236485097718743560282556743579770496207243310570,
        58508291964914420327294142954223286538392902807564621818104515410342077645613,
        36628570355032552369312250880819263729786881252903691461511741096057877446269,
        84452156900813384448609082987724841846138283748396489464674903776400435371405,
        47580532808391673264649910944163009365913105556571270704844270700934906886306,
        38597847667537176864195008764499342760554657691243026015464815512838341298531,
        76726445701449315767342066889806105842560196068485204966582505585635332737546,
        112262945085563849078138178410332731715548306547361811415364261237931404627739,
        83132523495420721436149789180924533950139084789920117794229983487608308779506,
        111012735145429917099433645376909171805909853167537041199859106407299891721317,
        97594023263608324054834977175921765235244582931900704731738485752450368596770,
        91534725245825204865798436285506770387292164604550168222044398600003545550019,
        70030593013623262455916920807184470813665630781741702411112903083540757165751,
        89944772814662462182461801664882903033701056223664497323224988308846794175818,
        87767190855904652578958044148762697449016747458870540175428778883380330073190,
        40080306972154416306488412404574532111647191346309405823533424648878208151291,
        59264035500820589583821723005915355685345305486627763606853449465302268930487,
        32030690069598978637648665417698590866482222868116614290363428007774886136739,
        11246573086260753259993971254725613211193686683988426513880826148090811891866,
        72238795475378817036443785137983712105833795587790215624804883986431857788086,
        11311085442652291634822798307831431035776248927202286895207125867542470350078,
        42866191232054535137687664432906740706734133743554169728045168653540819369396,
        792781492853909872425531014397300057232399608769451037135936617996830018501,
        5027602491523497423798779154966735896562099398367163998686335127580757861872,
        14595204575654316237672764823862241845410365278802914304953002937313300553572,
        101526510330978362002909882039456534408001887979827872015967916907139610879472,
        16395063164993626722686882727042150241125309409717445381854913964674649318585,
        96018740327404125439736139659200533642401299532915792273601850117958343249131,
        21345603324471810861925019445720576814602636473739003852898308205213912255830,
        43060227277691865566216644763950145888265422361524944867574974215593594436608,
        76425755729275813897376283517260358168819653154878313880284825161718489254498,
        72343027446583216501661783542760243853872475607423872623997586663391113479081,
        70658391197706458040941533501280676254241973237539868562980270134826962663608,
        105917139645852674564684223219472318788440263960475465458746704216817201103674,
        47282831354033165458229956338985941730237735086796394283611131945139628976063,
        109689947035399019903459002594912736054893246825448517364005553803465276858185,
        10090204501612803176317709245679152331057882187411777688746797044706063410969,
        108850121322435466252956322562850944588548446219554178670837592118158666955968,
        104282339630586929463328443041745466684670443426617059559256204236394390047567,
        26355434378604614587217464414049917283790561533427706903151232334217236928910,
        30565791031197288585537420052659875918627026956249687861541912238080391486449,
        66687680380644952485320683483132019121842565266120391421087093552946070542196,
        23776437942090855829219822810893705382966259823845274775293258371048739720069,
        91774236872259850135906433937392410479308974373628660123688971175043472562292,
        90378365058511733028453001410106539224373414623623951340733455652157227954347,
        41059273944532217500303025344978503110184035705028471693817867423180520988710,
        76445535827814956853356722753480728975133366276500508633356296038060756707584,
        105783908268490276933583693749113330687626826256408647343880056211429213703463,
        60677551715549930322422091571907242930065341041457054239734187466444357754615,
        22034737013442833543538173574780223542978122944126682746155655985591771597870,
        68157457894176972457149915570769780523893214071276644723092891816987715082399,
        24092467781845921757841339240519360281759056806549568023633047527813329729121,
        103615088897542941163602548278361431372717302036571149650385455316496468876038,
        115336142812873498940287100707540578394453951330758706311407947002385977969814,
        48723968483093628656710316280437628723131167720370054427800232890879817323520,
        38031508522484952102708051869101902868926616300926679605574071610074721933683,
        397690828254561723549349897112473766901585444153303054845160673059519614409,
        98825625086269370784495244162234495473092908835815801979041199549793855210155,
        59343413597985429889185873064836654600522801451354479864127539179872370582264,
        79887626835010309846901313377336077168703362379104276999242573414860473936408,
        16690275395485630428127725067513114066329712673106153451801968992299636791385,
        47443516734004517330972360350944221010789419773533540182154080192169425669818,
        86944767640019256509355545878294246568126352268718975452181552233209956269993,
        15895485136902450169492923978042129726601461603404514670348703312850236146328,
        95286022443659428873747755298056514679759659982504829832931541356434837795028,
        87991095288333502367758282644212548971769093238239924157358851843250054508284,
        814913922521637742587885320797606426167962526342166512693085292151314976633,
        78033440902599156520376891376036584744381105998274724908019008542231795085615,
        111936021216591510985541415421042638864186861105895092499268622641250080069654,
        103654103788871439878498569042815420991373301037550962477199064929810340295345,
        115693864644186336144157860136090608920512468335980864005222642777411480573741,
        9277135875276787021836189566799935097400042171346561246305113339462708861695,
        10493603554686607050979497281838644324893776154179810893893660722522945589063,
        96226061238019810124879982365323177051523406592674321730883947128740879631747,
        75223121888428192610985093155910474883124873094858231665513699541066486100101,
        62788773603801136591867026032279122459911198037993191176970290018146581638452,
        9783723818270121678386992630754842961728702994964214799008457449989291229500,
        15550788416669474113213749561488122552422887538676036667630838378023479382689,
        36904408617995508086316128317304444160334698216077144094558369220917381399838,
        94059197193067298052656179942329046341682437506267826392272657395967798961042,
        10796631184889302076168355684722130903785890709107732067446714470783437829037,
        19871836214837460419845806980869387567383718044439891735114283113359312279540,
        86535810382361292010488826325757897049676296718754884282297864168091260627473,
        26988348643356966664524838609347504504715360584208109651445786562538664316414,
        96330858599433373284236243282100681525579898452116109786853454972044359293354,
        27188683741975666501190619077401602784207525552041791881331036910678479394373,
        44981934287331483389126773723060257811024853467700522603117439257814949595770,
        49318985740988731974925113982657124510957178106256243154094477058742526328005,
        32916337117601607497471770708163213185207613561785127142203759126528334389910,
        84852043380354418785143815194314937672870040839625582653820326294951704783860,
        17047263688548829001253658727764731047114098556534482052135734487985276987385,
        107467821015536068044520247125387641889499818178891597831648638303724447588778,
        90482629572057815146501495902395837051273933278172252348419941315678678648132,
        102645233848076801051328786259677523105804224028900432398014333244613702938829,
        65355066084434203680543642140504741020649531107719007502893879918965747076214,
        88811752988578861209005482047065174029222514887171482707752356041924911279459,
        25707841289997007356695455034842955389725347420060009273227071872844511215780,
        8653175945487997845203439345797943132543211416447757110963967501177317426221,
        50391138734018986055606887660211654759621294819866105367558310515180584559376,
        41100758374813180044241517541460339264403360471913133726789188162193843887175,
        62440801658157844717778828361880213663158625406064579888814985202213909261003,
        11498264615058604317482574216318586415670903094838791165247179252175768794889,
        98366997901569540888093568114881531658677061817080669134328284101619461314242,
        83230914206248913863803923768891125212397220215676502662562526373497278917958,
        14016139747289624978792446847000951708158212463304817001882956166752906714332,
        95795573068699542639388354504765303242985894267079989480989235688618797842834,
        74909409591862905740991808449987886120643712871629774229390258178242472567839,
        77881507788252951205429092903078954527882216929330760516922971660446633676967,
        10702811721859145441471328511968332847175733707711670171718794132331147396634,
        50256153656470772984412173566637004125023091547738518766725861523759044364213,
        58894030397250104264989760012896322325421096280604431520731001373687265307419,
        50618688897675457708660667828011689869992028674971200016038881071814663718014,
        78397551908319363292748356749820421581721927509189327537599279030688676214906,
        94489244114228136629800651129087942231284317914181560721128694834600682871131,
        17297554111853491139852678417579991271009602631577069694853813331124433680030,
        104194567622107041462089939002394163385512717807223691048161151588787579847327,
        73065209805302979996308688222668280636682906917052110778323261423647416885932,
        111714419781413363441742503853955938988462408466509786158207585087045755332133,
        58939023807420693129799113772642084482309561450114254871979873943138336225690,
        27516281968279608144494984064905758951752895262194194603257235517863529751139,
        81750120811412517496307130639954502136971957091388878407903742344882518018111,
        14227467863135365427954093998621993651369686288941275436795622973781503444257,
        40112700265905821047799813136547383573670013597674982664594368591094492800739,
        87827916642089394681770203344578071172804761940673102098240489236329744671895,
        98603793735648218437205749611889574828138723878290400410849153369974542201997,
        111560756376128810158572842483495179405226765914790376043579900614874964823056,
        0]

      loopResult(iv, 0, 0, List.length(iv), 0, xL_in, xR_in, k)

    function loopResult(
        iv: list(int), 
        xl: int,
        xr: int,
        rounds: int,
        i: int,
        xL_in: int,
        xR_in: int,
        k: int): list(int) =
            switch(iv)
                [] => [xl, xr]
                (_iv :: iv) => 
                    let _t : int = 
                        if(i == 0)
                            k + xL_in
                        else
                            k + xl + _iv

                    let r: int = 52435875175126190479447740508185965837690552500527637822603658699938581184513 
                    let t2_now: int = _t * _t
                    let t4_now: int = t2_now * t2_now
                    let t5_now: int = (t4_now * _t) mod r // BLS12_381 scalar field
                    
                    let _xl : int =
                        if(i < rounds - 1)
                            if(i == 0)
                                (xR_in + t5_now) mod r
                            else
                                (xr + t5_now) mod r
                        else
                            xl
                    
                    let _xr : int =
                        if(i < rounds - 1)
                            if(i == 0)
                                xL_in
                            else
                                xl
                        else
                            (xr + t5_now) mod r                 
                    let i = i+1
                    loopResult(iv, _xl, _xr, rounds, i, xL_in, xR_in, k)